name: Build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: macos
            artifact: m0n1t0r-macos
            server_bin: m0n1t0r-server
            client_bin: m0n1t0r-client
            vcpkg_packages: libvpx libyuv opus aom ffmpeg
            compress: false
          - os: ubuntu-latest
            platform: linux
            artifact: m0n1t0r-linux
            server_bin: m0n1t0r-server
            client_bin: m0n1t0r-client
            vcpkg_packages: libvpx libyuv opus aom mfx-dispatch ffmpeg
            compress: true
          - os: windows-latest
            platform: winnt
            artifact: m0n1t0r-windows
            server_bin: m0n1t0r-server.exe
            client_bin: m0n1t0r-client.exe
            vcpkg_packages: libvpx:x64-windows-static libyuv:x64-windows-static opus:x64-windows-static aom:x64-windows-static mfx-dispatch:x64-windows-static ffmpeg:x64-windows-static
            compress: true

    runs-on: ${{ matrix.os }}

    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.platform }}

      - name: Install xmake
        uses: xmake-io/github-action-setup-xmake@v1

      # macOS dependencies
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install binutils meson nasm ninja autoconf automake autoconf-archive python3 libtool cmake gcc wget pkg-config libresample ffmpeg

      # Linux dependencies
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y zip g++ gcc git curl wget nasm yasm \
            libgtk-3-dev clang libxcb-randr0-dev libxdo-dev libxfixes-dev \
            libxcb-shape0-dev libxcb-xfixes0-dev libasound2-dev libpulse-dev \
            cmake make libclang-dev ninja-build \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libpam0g-dev \
            pkg-config libavutil-dev libavcodec-dev libavdevice-dev \
            libavfilter-dev libavformat-dev libswresample-dev libswscale-dev

      # Windows dependencies
      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        uses: MinoruSekine/setup-scoop@v4.0.2
        with:
          buckets: main
          apps: pkg-config

      # vcpkg setup with caching
      - name: Restore vcpkg cache
        id: vcpkg-cache
        uses: actions/cache@v4
        with:
          path: |
            vcpkg
            !vcpkg/.git
            !vcpkg/buildtrees
            !vcpkg/downloads
          key: vcpkg-${{ matrix.os }}-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: vcpkg-${{ matrix.os }}-

      - name: Clone vcpkg
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        run: git clone https://github.com/microsoft/vcpkg

      - name: Bootstrap vcpkg (Unix)
        if: steps.vcpkg-cache.outputs.cache-hit != 'true' && runner.os != 'Windows'
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Bootstrap vcpkg (Windows)
        if: steps.vcpkg-cache.outputs.cache-hit != 'true' && runner.os == 'Windows'
        run: .\vcpkg\bootstrap-vcpkg.bat

      - name: Install vcpkg packages
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        run: ./vcpkg/vcpkg install ${{ matrix.vcpkg_packages }}
        shell: bash

      - name: Cache cxxbridge-cmd
        id: cxxbridge-cache
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cxxbridge*
          key: cxxbridge-${{ runner.os }}-${{ hashFiles('Cargo.lock') }}

      - name: Install cxxbridge-cmd
        if: steps.cxxbridge-cache.outputs.cache-hit != 'true'
        run: cargo install cxxbridge-cmd

      - name: Generate TLS certificates
        run: cargo xtask -c
        shell: bash

      - name: Build server
        run: cargo build --bin m0n1t0r-server --features ${{ matrix.platform }} -r

      - name: Build client
        run: cargo build --bin m0n1t0r-client --features ${{ matrix.platform }} -r

      - name: Compress client binary
        if: matrix.compress
        run: cargo rel-xtask -u

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            ./target/release/${{ matrix.server_bin }}
            ./target/release/${{ matrix.client_bin }}
            ./certs
